<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gypsophila Bloom</title>
  <link rel="stylesheet" href="./main.css" />
</head>

<body>
  <div class="container">
    <canvas id="canvas"></canvas>
    <div class="clean-btn">clean the screen</div>
  </div>

  <div class="name">
    點擊畫面種下花朵
    <div class="subtitle">LAITETE MADE</div>
  </div>

  <!-- ===== Fragment Shader ===== -->
  <script type="x-shader/x-fragment" id="fragmentShader">
    #define PI 3.14159265359

    uniform float u_ratio;
    uniform vec2 u_cursor;
    uniform float u_stop_time;
    uniform float u_clean;
    uniform vec2 u_stop_randomizer;
    uniform sampler2D u_texture;
    uniform float u_time;

    varying vec2 vUv;

    vec3 mod289(vec3 x){return x-floor(x*(1.0/289.0))*289.0;}
    vec2 mod289(vec2 x){return x-floor(x*(1.0/289.0))*289.0;}
    vec3 permute(vec3 x){return mod289(((x*34.0)+1.0)*x);}
    float snoise(vec2 v){
      const vec4 C=vec4(0.211324865405187,0.366025403784439,-0.577350269189626,0.024390243902439);
      vec2 i=floor(v+dot(v,C.yy));
      vec2 x0=v-i+dot(i,C.xx);
      vec2 i1=(x0.x>x0.y)?vec2(1.0,0.0):vec2(0.0,1.0);
      vec4 x12=x0.xyxy+C.xxzz; x12.xy-=i1;
      i=mod289(i);
      vec3 p=permute(permute(i.y+vec3(0.0,i1.y,1.0))+i.x+vec3(0.0,i1.x,1.0));
      vec3 m=max(0.5-vec3(dot(x0,x0),dot(x12.xy,x12.xy),dot(x12.zw,x12.zw)),0.0);
      m=m*m; m=m*m;
      vec3 x=2.0*fract(p*C.www)-1.0;
      vec3 h=abs(x)-0.5;
      vec3 ox=floor(x+0.5);
      vec3 a0=x-ox;
      m*=1.79284291400159-0.85373472095314*(a0*a0+h*h);
      vec3 g;
      g.x=a0.x*x0.x+h.x*x0.y;
      g.yz=a0.yz*x12.xz+h.yz*x12.yw;
      return 130.0*dot(m,g);
    }

    float get_flower_shape(vec2 p,float pet,float ang,float outline){
      ang*=3.0;
      p=vec2(p.x*cos(ang)-p.y*sin(ang),p.x*sin(ang)+p.y*cos(ang));
      float a=atan(p.y,p.x);
      float sector=pow(abs(sin(a*pet)),.4)+.25;
      float size=.03+u_stop_randomizer.x*.05;
      float r=pow(length(p)/size,2.);
      r=max(.1,r);
      float grow=step(.25,u_stop_time)*pow(u_stop_time,.3);
      float shape=1.-smoothstep(0.,sector,outline*r/grow);
      shape*=1.-step(1.,grow);
      return shape;
    }

    float get_stem_shape(vec2 p,vec2 uv,float w,float ang){
      w=max(.004,w);
      float xoff=p.y*sin(ang); xoff*=pow(3.*uv.y,2.);
      p.x-=xoff;
      float n=.4*snoise(uv*2.+u_stop_randomizer.x);
      p.x+=n*pow(p.y,2.);
      float l=smoothstep(-w,0.,p.x);
      float r=1.-smoothstep(0.,w,p.x);
      float s=l*r;
      s*=1.-step(.17,u_stop_time);
      return s;
    }

    void main(){
      vec3 base=texture2D(u_texture,vUv).xyz;
      vec2 uv=vUv; uv.x*=u_ratio;

      vec2 cursor=vUv-u_cursor;
      cursor.x*=u_ratio;

      vec2 cursorStem=cursor;
      vec2 cursorFlower=cursor;

      float topMask=smoothstep(0.4,0.95,vUv.y);
      float wind=sin(u_time*0.7+vUv.x*2.0+u_stop_randomizer.x*6.28)*0.012;
      cursorFlower.x+=wind*topMask;
      cursorFlower.x+=0.003*snoise(vUv*5.0+vec2(u_time*.25,0.))*topMask;

      vec3 stem_color=vec3(.2,.6,.3);
      vec3 flower_color=vec3(.95,.95,.95);

      float angle=.5*(u_stop_randomizer.x-.5);

      float stem=get_stem_shape(cursorStem,uv,.003,angle);
      float stem_mask=1.-get_stem_shape(cursorStem,uv,.004,angle);

      float flower=get_flower_shape(cursorFlower,1.,angle,1.);
      float flower_mask=1.-get_flower_shape(cursorFlower,1.,angle,.95);

      vec3 col=base;
      col*=stem_mask;
      col*=flower_mask;
      col+=stem*stem_color;
      col+=flower*flower_color;
      col*=u_clean;

      gl_FragColor=vec4(col,1.);
    }
  </script>

  <!-- ===== Vertex Shader ===== -->
  <script type="x-shader/x-vertex" id="vertexShader">
    varying vec2 vUv;
    void main(){
      vUv=uv;
      gl_Position=vec4(position,1.);
    }
  </script>

  <script type="module" src="./main.js"></script>
</body>
</html>
